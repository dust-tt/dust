{"version":3,"sources":["../src/tools/callDustAgent.ts"],"sourcesContent":["import type { Tool, ToolContext } from \"./index.js\";\n\nexport function callDustAgentTool(context: ToolContext): Tool {\n  return {\n    name: \"call_dust_agent\",\n    description:\n      \"Call a Dust workspace agent to delegate tasks to specialized agents. \" +\n      \"Use this to leverage agents configured in your Dust workspace \" +\n      \"(e.g., @security-auditor, @code-reviewer, @docs-writer). \" +\n      \"The agent will receive your message and return a response.\",\n    inputSchema: {\n      type: \"object\",\n      properties: {\n        agent: {\n          type: \"string\",\n          description:\n            'Agent name or sId. Use the name with @ prefix (e.g. \"@security-auditor\") ' +\n            \"or the agent sId directly.\",\n        },\n        message: {\n          type: \"string\",\n          description: \"The message to send to the agent.\",\n        },\n        context: {\n          type: \"string\",\n          description:\n            \"Optional additional context to include (e.g., code snippets, file contents).\",\n        },\n      },\n      required: [\"agent\", \"message\"],\n    },\n    async execute(input) {\n      const dustClient = context.dustClient;\n      if (!dustClient) {\n        return \"Error: Dust client not available. Cannot call workspace agents.\";\n      }\n\n      const agentName = (input.agent as string).replace(/^@/, \"\");\n      const message = input.message as string;\n      const additionalContext = input.context as string | undefined;\n\n      // Resolve agent by name.\n      const agentsRes = await dustClient.getAgentConfigurations({ view: \"list\" });\n      if (agentsRes.isErr()) {\n        return `Error fetching agent configurations: ${agentsRes.error.message}`;\n      }\n\n      const agents = agentsRes.value;\n      const agent = agents.find(\n        (a) =>\n          a.name.toLowerCase() === agentName.toLowerCase() ||\n          a.sId === agentName\n      );\n\n      if (!agent) {\n        const available = agents\n          .slice(0, 20)\n          .map((a) => `@${a.name}`)\n          .join(\", \");\n        return `Error: Agent \"${agentName}\" not found. Available agents: ${available}`;\n      }\n\n      // Build the full message content.\n      let fullMessage = message;\n      if (additionalContext) {\n        fullMessage += `\\n\\n---\\nContext:\\n${additionalContext}`;\n      }\n\n      // Create conversation with the agent.\n      const convRes = await dustClient.createConversation({\n        title: null,\n        visibility: \"unlisted\",\n        message: {\n          content: fullMessage,\n          mentions: [{ configurationId: agent.sId }],\n          context: {\n            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n            username: \"coding-cli\",\n            fullName: null,\n            email: null,\n            profilePictureUrl: null,\n            origin: \"api\" as const,\n          },\n        },\n      });\n\n      if (convRes.isErr()) {\n        return `Error creating conversation: ${convRes.error.message}`;\n      }\n\n      const { conversation, message: userMessage } = convRes.value;\n\n      if (!userMessage) {\n        return \"Error: No user message was created.\";\n      }\n\n      // Stream the agent's response.\n      const streamRes = await dustClient.streamAgentAnswerEvents({\n        conversation,\n        userMessageId: userMessage.sId,\n      });\n\n      if (streamRes.isErr()) {\n        const err = streamRes.error;\n        const errMessage = err instanceof Error ? err.message : String(err);\n        return `Error streaming agent response: ${errMessage}`;\n      }\n\n      const { eventStream } = streamRes.value;\n\n      let responseText = \"\";\n\n      for await (const event of eventStream) {\n        if (event.type === \"generation_tokens\" && \"text\" in event) {\n          responseText += event.text;\n        }\n        if (event.type === \"agent_error\") {\n          return `Agent error: ${event.error.message}`;\n        }\n      }\n\n      if (!responseText) {\n        return \"Agent returned an empty response.\";\n      }\n\n      return responseText;\n    },\n  };\n}\n"],"mappings":";AAEO,SAAS,kBAAkB,SAA4B;AAC5D,SAAO;AAAA,IACL,MAAM;AAAA,IACN,aACE;AAAA,IAIF,aAAa;AAAA,MACX,MAAM;AAAA,MACN,YAAY;AAAA,QACV,OAAO;AAAA,UACL,MAAM;AAAA,UACN,aACE;AAAA,QAEJ;AAAA,QACA,SAAS;AAAA,UACP,MAAM;AAAA,UACN,aAAa;AAAA,QACf;AAAA,QACA,SAAS;AAAA,UACP,MAAM;AAAA,UACN,aACE;AAAA,QACJ;AAAA,MACF;AAAA,MACA,UAAU,CAAC,SAAS,SAAS;AAAA,IAC/B;AAAA,IACA,MAAM,QAAQ,OAAO;AACnB,YAAM,aAAa,QAAQ;AAC3B,UAAI,CAAC,YAAY;AACf,eAAO;AAAA,MACT;AAEA,YAAM,YAAa,MAAM,MAAiB,QAAQ,MAAM,EAAE;AAC1D,YAAM,UAAU,MAAM;AACtB,YAAM,oBAAoB,MAAM;AAGhC,YAAM,YAAY,MAAM,WAAW,uBAAuB,EAAE,MAAM,OAAO,CAAC;AAC1E,UAAI,UAAU,MAAM,GAAG;AACrB,eAAO,wCAAwC,UAAU,MAAM,OAAO;AAAA,MACxE;AAEA,YAAM,SAAS,UAAU;AACzB,YAAM,QAAQ,OAAO;AAAA,QACnB,CAAC,MACC,EAAE,KAAK,YAAY,MAAM,UAAU,YAAY,KAC/C,EAAE,QAAQ;AAAA,MACd;AAEA,UAAI,CAAC,OAAO;AACV,cAAM,YAAY,OACf,MAAM,GAAG,EAAE,EACX,IAAI,CAAC,MAAM,IAAI,EAAE,IAAI,EAAE,EACvB,KAAK,IAAI;AACZ,eAAO,iBAAiB,SAAS,kCAAkC,SAAS;AAAA,MAC9E;AAGA,UAAI,cAAc;AAClB,UAAI,mBAAmB;AACrB,uBAAe;AAAA;AAAA;AAAA;AAAA,EAAsB,iBAAiB;AAAA,MACxD;AAGA,YAAM,UAAU,MAAM,WAAW,mBAAmB;AAAA,QAClD,OAAO;AAAA,QACP,YAAY;AAAA,QACZ,SAAS;AAAA,UACP,SAAS;AAAA,UACT,UAAU,CAAC,EAAE,iBAAiB,MAAM,IAAI,CAAC;AAAA,UACzC,SAAS;AAAA,YACP,UAAU,KAAK,eAAe,EAAE,gBAAgB,EAAE;AAAA,YAClD,UAAU;AAAA,YACV,UAAU;AAAA,YACV,OAAO;AAAA,YACP,mBAAmB;AAAA,YACnB,QAAQ;AAAA,UACV;AAAA,QACF;AAAA,MACF,CAAC;AAED,UAAI,QAAQ,MAAM,GAAG;AACnB,eAAO,gCAAgC,QAAQ,MAAM,OAAO;AAAA,MAC9D;AAEA,YAAM,EAAE,cAAc,SAAS,YAAY,IAAI,QAAQ;AAEvD,UAAI,CAAC,aAAa;AAChB,eAAO;AAAA,MACT;AAGA,YAAM,YAAY,MAAM,WAAW,wBAAwB;AAAA,QACzD;AAAA,QACA,eAAe,YAAY;AAAA,MAC7B,CAAC;AAED,UAAI,UAAU,MAAM,GAAG;AACrB,cAAM,MAAM,UAAU;AACtB,cAAM,aAAa,eAAe,QAAQ,IAAI,UAAU,OAAO,GAAG;AAClE,eAAO,mCAAmC,UAAU;AAAA,MACtD;AAEA,YAAM,EAAE,YAAY,IAAI,UAAU;AAElC,UAAI,eAAe;AAEnB,uBAAiB,SAAS,aAAa;AACrC,YAAI,MAAM,SAAS,uBAAuB,UAAU,OAAO;AACzD,0BAAgB,MAAM;AAAA,QACxB;AACA,YAAI,MAAM,SAAS,eAAe;AAChC,iBAAO,gBAAgB,MAAM,MAAM,OAAO;AAAA,QAC5C;AAAA,MACF;AAEA,UAAI,CAAC,cAAc;AACjB,eAAO;AAAA,MACT;AAEA,aAAO;AAAA,IACT;AAAA,EACF;AACF;","names":[]}
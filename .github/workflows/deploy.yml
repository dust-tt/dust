name: Deploy
run-name: Deploy ${{ inputs.component }} to ${{ inputs.regions }}

on:
  workflow_dispatch:
    inputs:
      regions:
        description: "Regions to deploy to"
        required: true
        default: "all"
        type: choice
        options:
          - "us-central1"
          - "europe-west1"
          - "all"
      component:
        description: "Name of the component to deploy"
        required: true
        type: choice
        default:
        options:
          - connectors
          - core
          - front
          - front-edge
          - prodbox
          - oauth
          - viz
          - dante
      check_deployment_blocked:
        description: "Check #deployment locks or force deploy"
        required: true
        default: "check"
        type: choice
        options:
          - "check"
          - "force (dangerous)"
      depot_region:
        description: "Depot region to use for building"
        required: true
        default: "us"
        type: choice
        options:
          - "us"
          - "eu"
      deploy_spa_app:
        description: "Deploy SPA for app (front only)"
        required: false
        default: true
        type: boolean
      deploy_spa_poke:
        description: "Deploy SPA for poke (front only)"
        required: false
        default: true
        type: boolean
      override_dust_app_url:
        description: "Override NEXT_PUBLIC_DUST_APP_URL with https://app.dust.tt (front-edge only)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: "deploy_${{ inputs.component }}${{ inputs.component == 'front-edge' && format('_{0}', github.run_id) || '' }}"
  cancel-in-progress: false

jobs:
  check-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check if deployment is from main branch
        if: ${{ github.ref != 'refs/heads/main' && inputs.component != 'front-edge' }}
        run: |
          echo "Error: Deployments for ${{ inputs.component }} are only allowed from the main branch"
          exit 1

  prepare:
    needs: [check-branch]
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.short_sha.outputs.short_sha }}
      long_sha: ${{ steps.short_sha.outputs.long_sha }}
    steps:
      - uses: actions/checkout@v3
      - name: Get short sha
        id: short_sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Get long sha
        id: long_sha
        run: echo "long_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  notify-start:
    needs: [prepare]
    runs-on: ubuntu-latest
    outputs:
      thread_ts: ${{ steps.build_message.outputs.thread_ts }}
    steps:
      - uses: actions/checkout@v3

      - name: Notify Build And Deploy Start
        id: build_message
        uses: ./.github/actions/slack-notify
        with:
          step: "start"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          component: ${{ inputs.component }}
          image_tag: ${{ needs.prepare.outputs.short_sha }}
          region: ${{ inputs.regions }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Slack Check Deployment Blocked
        if: ${{ inputs.check_deployment_blocked == 'check' }}
        id: check_deployment_blocked
        uses: ./.github/actions/slack-check-deployment-blocked
        with:
          component: ${{ inputs.component }}
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}

  create-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ inputs.regions }}" = "all" ]; then
            echo "matrix=[\"us-central1\",\"europe-west1\"]" >> $GITHUB_OUTPUT
          else
            echo "matrix=[\"${{ inputs.regions }}\"]" >> $GITHUB_OUTPUT
          fi

  build:
    permissions:
      contents: read
      id-token: write
    needs: [prepare, notify-start, create-matrix]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: ${{ fromJson(needs.create-matrix.outputs.matrix) }}
      fail-fast: true

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 50 # Fetch last 50 commits for commit diff functionality

      - name: Set project ID
        id: project
        run: |
          if [ "${{ matrix.region }}" = "us-central1" ]; then
            echo "PROJECT_ID=${{ secrets.GCLOUD_US_PROJECT_ID }}" >> $GITHUB_OUTPUT
          else
            echo "PROJECT_ID=${{ secrets.GCLOUD_EU_PROJECT_ID }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Image
        id: build
        uses: ./.github/actions/build-image
        with:
          commit_sha_long: ${{ needs.prepare.outputs.long_sha }}
          commit_sha: ${{ needs.prepare.outputs.short_sha }}
          component: ${{ inputs.component }}
          dd_api_key: ${{ secrets.DD_API_KEY }}
          dd_client_token: ${{ secrets.DD_CLIENT_TOKEN }}
          depot_eu_project_id: ${{ secrets.DEPOT_EU_PROJECT_ID }}
          depot_eu_token: ${{ secrets.DEPOT_EU_PROJECT_TOKEN }}
          depot_region: ${{ inputs.depot_region }}
          depot_us_project_id: ${{ secrets.DEPOT_PROJECT_ID }}
          depot_us_token: ${{ secrets.DEPOT_PROJECT_TOKEN }}
          project_id: ${{ steps.project.outputs.PROJECT_ID }}
          region: ${{ matrix.region }}
          virtuoso_license_key: ${{ secrets.VIRTUOSO_LICENSE_KEY }}
          contentful_space_id: ${{ secrets.CONTENTFUL_SPACE_ID }}
          contentful_access_token: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}
          workload_identity_provider: "projects/357744735673/locations/global/workloadIdentityPools/github-pool-apps/providers/github-provider-apps"
          override_dust_app_url: ${{ inputs.override_dust_app_url }}

      - name: Notify build success
        uses: ./.github/actions/slack-notify
        with:
          step: "build_success"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          thread_ts: ${{ needs.notify-start.outputs.thread_ts }}
          component: ${{ inputs.component }}
          image_tag: ${{ needs.prepare.outputs.short_sha }}
          region: ${{ matrix.region }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          current_version: ${{ steps.build.outputs.current_version }}
          commit_diff: ${{ steps.build.outputs.commit_diff }}
          commit_count: ${{ steps.build.outputs.commit_count }}

      - name: Notify Failure
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          step: "failure"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          component: ${{ inputs.component }}
          image_tag: ${{ needs.prepare.outputs.short_sha }}
          region: ${{ inputs.regions }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          thread_ts: "${{ needs.notify-start.outputs.thread_ts }}"

  deploy:
    needs: [prepare, notify-start, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INFRA_DISPATCH_APP_ID }}
          private-key: ${{ secrets.INFRA_DISPATCH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: dust-infra

      - name: Trigger dust-infra workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: '${{ github.repository_owner }}',
              repo: 'dust-infra',
              event_type: 'trigger-component-deploy',
              client_payload: {
                regions: '${{ inputs.regions }}',
                component: '${{ inputs.component }}',
                image_tag: '${{ needs.prepare.outputs.short_sha }}',
                slack_thread_ts: "${{ needs.notify-start.outputs.thread_ts }}",
                slack_channel: '${{ secrets.SLACK_CHANNEL_ID }}',
                run_playwright: '${{ inputs.run_playwright_tests }}',
                playwright_sha: '${{ github.sha }}'
              }
            })

      - name: Notify Failure
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          step: "failure"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          component: ${{ inputs.component }}
          image_tag: ${{ needs.prepare.outputs.short_sha }}
          region: ${{ inputs.regions }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          thread_ts: "${{ needs.notify-start.outputs.thread_ts }}"

  # Phase 1: Upload SPA to CF Pages as preview (assets propagate, production alias unchanged).
  # Starts in parallel with Docker build to save time.
  deploy-app:
    if: (inputs.component == 'front' || inputs.component == 'front-edge') && inputs.deploy_spa_app
    needs: [notify-start]
    uses: ./.github/workflows/deploy-spa.yaml
    with:
      app: "app"
      env: ${{ inputs.component == 'front-edge' && 'edge' || 'prod' }}
      region: "us"
      thread_ts: ${{ needs.notify-start.outputs.thread_ts }}
      promote: false
    secrets: inherit

  deploy-poke:
    if: (inputs.component == 'front' || inputs.component == 'front-edge') && inputs.deploy_spa_poke
    needs: [notify-start]
    uses: ./.github/workflows/deploy-spa.yaml
    with:
      app: "poke"
      env: ${{ inputs.component == 'front-edge' && 'edge' || 'prod' }}
      region: "us"
      thread_ts: ${{ needs.notify-start.outputs.thread_ts }}
      promote: false
    secrets: inherit

  # Phase 2: Promote SPA to production after the API is live with the new version.
  # Polls /api/healthz/ready until commitHash matches the expected SHA.
  promote-app:
    if: (inputs.component == 'front' || inputs.component == 'front-edge') && inputs.deploy_spa_app
    needs: [prepare, deploy, deploy-app]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for API to be live
        env:
          EXPECTED_SHA: ${{ needs.prepare.outputs.short_sha }}
          COMPONENT: ${{ inputs.component }}
          REGIONS: ${{ inputs.regions }}
        run: |
          # Build list of URLs to poll based on component and regions.
          URLS=""
          if [ "$COMPONENT" = "front-edge" ]; then
            BASE="front-edge.dust.tt"
          else
            BASE="dust.tt"
          fi
          if [ "$REGIONS" = "us-central1" ] || [ "$REGIONS" = "all" ]; then
            URLS="$URLS https://$BASE/api/healthz/ready"
          fi
          if [ "$REGIONS" = "europe-west1" ] || [ "$REGIONS" = "all" ]; then
            URLS="$URLS https://eu.$BASE/api/healthz/ready"
          fi

          echo "Waiting for API to serve commitHash=$EXPECTED_SHA on:$URLS"
          for URL in $URLS; do
            echo "Polling $URL ..."
            for i in $(seq 1 60); do
              RESPONSE=$(curl -sf "$URL" 2>/dev/null || echo '{}')
              LIVE_HASH=$(echo "$RESPONSE" | jq -r '.commitHash // empty')
              if [ "$LIVE_HASH" = "$EXPECTED_SHA" ]; then
                echo "$URL is live with expected version after $((i * 10))s"
                break
              fi
              echo "  Attempt $i/60: got commitHash=$LIVE_HASH, waiting 10s..."
              sleep 10
              if [ "$i" = "60" ]; then
                echo "::warning::$URL did not reach expected version after 10 minutes. Promoting SPA anyway."
              fi
            done
          done

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: spa-dist-app
          path: front-spa/dist/app

      - name: Promote to production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: front-spa
          command: pages deploy dist/app --project-name=app-dust-tt

  promote-poke:
    if: (inputs.component == 'front' || inputs.component == 'front-edge') && inputs.deploy_spa_poke
    needs: [prepare, deploy, deploy-poke]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for API to be live
        env:
          EXPECTED_SHA: ${{ needs.prepare.outputs.short_sha }}
          COMPONENT: ${{ inputs.component }}
          REGIONS: ${{ inputs.regions }}
        run: |
          # Build list of URLs to poll based on component and regions.
          URLS=""
          if [ "$COMPONENT" = "front-edge" ]; then
            BASE="front-edge.dust.tt"
          else
            BASE="dust.tt"
          fi
          if [ "$REGIONS" = "us-central1" ] || [ "$REGIONS" = "all" ]; then
            URLS="$URLS https://$BASE/api/healthz/ready"
          fi
          if [ "$REGIONS" = "europe-west1" ] || [ "$REGIONS" = "all" ]; then
            URLS="$URLS https://eu.$BASE/api/healthz/ready"
          fi

          echo "Waiting for API to serve commitHash=$EXPECTED_SHA on:$URLS"
          for URL in $URLS; do
            echo "Polling $URL ..."
            for i in $(seq 1 60); do
              RESPONSE=$(curl -sf "$URL" 2>/dev/null || echo '{}')
              LIVE_HASH=$(echo "$RESPONSE" | jq -r '.commitHash // empty')
              if [ "$LIVE_HASH" = "$EXPECTED_SHA" ]; then
                echo "$URL is live with expected version after $((i * 10))s"
                break
              fi
              echo "  Attempt $i/60: got commitHash=$LIVE_HASH, waiting 10s..."
              sleep 10
              if [ "$i" = "60" ]; then
                echo "::warning::$URL did not reach expected version after 10 minutes. Promoting SPA anyway."
              fi
            done
          done

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: spa-dist-poke
          path: front-spa/dist/poke

      - name: Promote to production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: front-spa
          command: pages deploy dist/poke --project-name=poke-dust-tt

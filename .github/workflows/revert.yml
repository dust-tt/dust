name: Revert Workflow
run-name: Revert ${{ inputs.component }} in ${{ inputs.regions }}

on:
  workflow_dispatch:
    inputs:
      regions:
        description: "Regions to revert"
        required: true
        default: "all"
        type: choice
        options:
          - "us-central1"
          - "europe-west1"
          - "all"
      image_tag:
        description: "The image tag/SHA to deploy"
        type: string
        required: true
      component:
        description: "Component to revert"
        type: choice
        options:
          - connectors
          - core
          - front
          - front-edge
          - metabase
          - oauth
          - prodbox
          - viz
        required: true
    secrets:
      SLACK_CHANNEL_ID:
        required: true
      SLACK_BOT_TOKEN:
        required: true
      INFRA_DISPATCH_APP_ID:
        required: true
      INFRA_DISPATCH_APP_PRIVATE_KEY:
        required: true
      GCLOUD_US_PROJECT_ID:
        required: true
      GCLOUD_EU_PROJECT_ID:
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-branch:
    runs-on: ubuntu-latest
    if: ${{ !inputs.enforce_main || github.ref == 'refs/heads/main' }}
    steps:
      - name: Check branch condition
        run: |
          if [[ "${{ inputs.enforce_main }}" == "true" && "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "Reverts are only allowed from the main branch"
            exit 1
          fi

  notify-start:
    runs-on: ubuntu-latest
    outputs:
      thread_ts: ${{ steps.build_message.outputs.thread_ts }}
    steps:
      - uses: actions/checkout@v3

      - name: Notify Start
        id: build_message
        uses: ./.github/actions/slack-notify
        with:
          step: "start"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          component: ${{ inputs.component }}
          image_tag: ${{ inputs.image_tag }}
          region: ${{ inputs.regions }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          is_revert: true

  create-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ inputs.regions }}" = "all" ]; then
            echo "matrix=[\"us-central1\",\"europe-west1\"]" >> $GITHUB_OUTPUT
          else
            echo "matrix=[\"${{ inputs.regions }}\"]" >> $GITHUB_OUTPUT
          fi

  validate-image:
    permissions:
      contents: read
      id-token: write
    needs: [notify-start, create-matrix]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        region: ${{ fromJson(needs.create-matrix.outputs.matrix) }}
      fail-fast: true
    steps:
      - uses: actions/checkout@v3

      - name: Set project ID
        id: project
        run: |
          if [ "${{ matrix.region }}" = "us-central1" ]; then
            echo "PROJECT_ID=${{ secrets.GCLOUD_US_PROJECT_ID }}" >> $GITHUB_OUTPUT
          else
            echo "PROJECT_ID=${{ secrets.GCLOUD_EU_PROJECT_ID }}" >> $GITHUB_OUTPUT
          fi

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          create_credentials_file: true
          workload_identity_provider: "projects/357744735673/locations/global/workloadIdentityPools/github-pool-apps/providers/github-provider-apps"
          service_account: "github-build-invoker@${{ steps.project.outputs.PROJECT_ID }}.iam.gserviceaccount.com"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: Validate image tag exists
        run: |
          echo "Validating image tag ${{ inputs.image_tag }} exists for ${{ inputs.component }} in ${{ matrix.region }}"

          IMAGE_REPO="${{ matrix.region }}-docker.pkg.dev/${{ steps.project.outputs.PROJECT_ID }}/dust-images/${{ inputs.component }}"

          if ! gcloud container images describe "${IMAGE_REPO}:${{ inputs.image_tag }}" --quiet >/dev/null 2>&1; then
            echo "❌ Image tag '${{ inputs.image_tag }}' not found in registry ${IMAGE_REPO}"
            echo "Available tags:"
            gcloud container images list-tags "${IMAGE_REPO}" \
              --limit=10 \
              --sort-by=~timestamp \
              --format="table(timestamp.date('%Y-%m-%d %H:%M:%S'),tags[0])"
            exit 1
          fi

          echo "✅ Image tag '${{ inputs.image_tag }}' exists in ${{ matrix.region }} registry" >> $GITHUB_STEP_SUMMARY

      - name: Notify Failure
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          step: "failure"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          component: ${{ inputs.component }}
          image_tag: ${{ inputs.image_tag }}
          region: ${{ matrix.region }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          thread_ts: "${{ needs.notify-start.outputs.thread_ts }}"
          is_revert: true

  revert:
    needs: [notify-start, validate-image]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.INFRA_DISPATCH_APP_ID }}
          private-key: ${{ secrets.INFRA_DISPATCH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: dust-infra

      - name: Trigger dust-infra workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: '${{ github.repository_owner }}',
              repo: 'dust-infra',
              event_type: 'trigger-component-revert',
              client_payload: {
                regions: '${{ inputs.regions }}',
                component: '${{ inputs.component }}',
                image_tag: '${{ inputs.image_tag }}',
                slack_thread_ts: "${{ needs.notify-start.outputs.thread_ts }}",
                slack_channel: '${{ secrets.SLACK_CHANNEL_ID }}',
                run_playwright: false,
              }
            })

      - name: Notify Failure
        if: failure()
        uses: ./.github/actions/slack-notify
        with:
          step: "failure"
          channel: ${{ secrets.SLACK_CHANNEL_ID }}
          component: ${{ inputs.component }}
          image_tag: ${{ inputs.image_tag }}
          region: ${{ inputs.regions }}
          slack_token: ${{ secrets.SLACK_BOT_TOKEN }}
          thread_ts: "${{ needs.notify-start.outputs.thread_ts }}"
          is_revert: true

name: "Build Docker Image"
description: "Builds a Docker image using Cloud Build"

inputs:
  project_id:
    description: "Google Cloud project ID"
    required: true
  region:
    description: "Region to build in"
    required: true
  component:
    description: "Component name"
    required: true
  workload_identity_provider:
    description: "Workload Identity Provider"
    required: true
  depot_token:
    description: "Depot project token"
    required: true

runs:
  using: "composite"
  steps:
    - id: "auth"
      name: "Authenticate to Google Cloud"
      uses: "google-github-actions/auth@v2"
      with:
        create_credentials_file: true
        workload_identity_provider: ${{ inputs.workload_identity_provider }}
        service_account: "github-build-invoker@${{ inputs.project_id }}.iam.gserviceaccount.com"

    - name: "Configure GCP Artifact Auth"
      uses: "google-github-actions/setup-gcloud@v2"
      with:
        install_components: "docker-credential-gcr"

    - name: "Setup Depot"
      uses: "depot/setup-action@v1"

    - name: "Build and Push"
      shell: bash
      env:
        DEPOT_TOKEN: ${{ inputs.depot_token }}
      run: |
        CONFIG_FILE=".github/configs/${{ inputs.region }}/.env.$(
          if [[ ${{ inputs.component }} == *"qa"* ]]; then echo "qa";
          elif [[ ${{ inputs.component }} == *"edge"* ]]; then echo "edge";
          else echo "prod"; fi
        )"

        build_args=()
        while IFS='=' read -r key value; do
          [[ -n "$key" ]] && build_args+=("--build-arg" "$(echo "$key" | xargs)=$(echo "$value" | xargs)")
        done < "$CONFIG_FILE"

        depot build \
          --project 3vz0lnf16v \
          --platform linux/amd64 \
          --cache-from type=gha,scope=${{ inputs.component }} \
          --cache-to type=gha,mode=max,scope=${{ inputs.component }} \
          -f ./dockerfiles/${{ inputs.component }}.Dockerfile \
          -t ${{ inputs.region }}-docker.pkg.dev/${{ inputs.project_id }}/dust-images/${{ inputs.component }}:${GITHUB_SHA::7} \
          --build-arg COMMIT_HASH=${GITHUB_SHA::7} \
          ${build_args[@]} \
          --push \
          .
# Configuration for mprocs to run the dev environment locally.
# Requirements:
# * mprocs (`brew install mprocs`)
# * bacon (`cargo install bacon`)

# ⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️
# you need to restart front-workers after sdks-js is loaded: select front-workers in the mprocs window and press r
# ⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️⚠️

procs:
  core:
    cwd: "<CONFIG_DIR>/../core"
    shell: "bacon core-api"

  sqlite-workers:
    cwd: "<CONFIG_DIR>/../core"
    env:
      CORE_API: "http://localhost:3001"
      IS_LOCAL_DEV: "1"
      DATABASES_STORE_DATABASE_URI: "postgresql://dev:dev@localhost:5432/dust_databases_store"
      CORE_API_KEY: "soupinou"
    shell: "bacon sqlite-worker"

  oauth:
    cwd: "<CONFIG_DIR>/../core"
    shell: "bacon oauth"

  sparkle:
    cwd: "<CONFIG_DIR>/../sparkle"
    shell: |
      set -euo pipefail
      npm run watch

  sdks-js:
    cwd: "<CONFIG_DIR>/../sdks/js"
    shell: |
      set -euo pipefail
      ./admin/dev.sh

  front:
    cwd: "<CONFIG_DIR>/../front"
    shell: |
      set -euo pipefail
      READY_FILE="../sdks/js/dist/client.esm.js.map"
      echo "Waiting for sdks-js to compile..."
      echo "Expecting file: $READY_FILE"
      while [ ! -f "$READY_FILE" ]; do sleep 1; done
      echo "sdks-js ready. Starting front."
      ./admin/dev.sh

  front-workers:
    cwd: "<CONFIG_DIR>/../front"
    shell: |
      set -euo pipefail
      echo "Waiting for front to be ready..."
      until curl -sf http://localhost:3000/api/healthz; do sleep 1; done
      echo "front ready. Starting front-workers."
      ./admin/dev_worker.sh

  connectors:
    cwd: "<CONFIG_DIR>/../connectors"
    shell: |
      set -euo pipefail
      READY_FILE="../sdks/js/dist/client.esm.js.map"
      echo "Waiting for sdks-js to compile..."
      while [ ! -f "$READY_FILE" ]; do sleep 1; done
      echo "sdks-js ready. Starting connectors."
      ./admin/dev.sh

  front-spa:
    cwd: "<CONFIG_DIR>/../front-spa"
    shell: |
      set -euo pipefail
      READY_FILE="../sparkle/dist/cjs/index.js"
      echo "Waiting for sparkle to compile..."
      echo "Expecting file: $READY_FILE"
      while [ ! -f "$READY_FILE" ]; do sleep 1; done
      npm run dev:app
    autostart: false

  front-poke:
    cwd: "<CONFIG_DIR>/../front-spa"
    shell: |
      set -euo pipefail
      READY_FILE="../sparkle/dist/cjs/index.js"
      echo "Waiting for sparkle to compile..."
      echo "Expecting file: $READY_FILE"
      while [ ! -f "$READY_FILE" ]; do sleep 1; done
      npm run dev:poke
    autostart: false

  sparkle-storybook:
    cwd: "<CONFIG_DIR>/../sparkle"
    shell: "npm run storybook"
    autostart: false

  sparkle-playground:
    cwd: "<CONFIG_DIR>/../sparkle/playground"
    shell: "npm install && npm run dev"
    autostart: false

  viz:
    cwd: "<CONFIG_DIR>/../viz"
    shell: "npm run dev"
    autostart: false

  extension:
    cwd: "<CONFIG_DIR>/../extension"
    shell: "npm run dev:chrome"
    autostart: false

  ngrok:
    # Doc: https://www.notion.so/dust-tt/Runbook-Local-Setup-Slack-2ad003fc529d4144bb0ee61b7fd797c9?source=copy_link#2a728599d941807fb71dccb4addc0234
    shell: "ngrok start localhost-via-https"
    autostart: false

  firebase-webhook-router:
    cwd: "<CONFIG_DIR>/../firebase-functions/webhook-router"
    shell: "docker-compose up --build"
    autostart: false

  novu:
    # Doc: https://docs.novu.co/framework/studio
    shell: "npx novu@latest dev --port 3000"
    autostart: false
